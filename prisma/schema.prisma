
generator client {
  provider      = "prisma-client"
  output        = "../src/generated/prisma"
  binaryTargets = ["native", "rhel-openssl-3.0.x"]
}

datasource db {
  provider = "postgresql"
}

model User {
  id            String    @id @default(cuid())
  name          String
  email         String
  emailVerified Boolean   @default(false)
  image         String?
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @default(now()) @updatedAt
  sessions      Session[]
  accounts      Account[]

  members                 Member[]
  invitations             Invitation[]
  trackings               TrackingParticipant[]
  leadHistories           LeadHistory[]
  participantOnActions    ActionsUserParticipant[]
  responsibleOnActions    ActionsUserResponsible[]
  actions                 Action[]
  responsibleOnSubActions SubActionUserResponsible[]
  responsibleOnLeads      Lead[]  @relation("LeadResponsible")
  worflows Workflow[]

  @@unique([email])
  @@map("user")
}

model Session {
  id        String   @id @default(cuid())
  expiresAt DateTime
  token     String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  ipAddress String?
  userAgent String?
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  activeOrganizationId String?

  @@unique([token])
  @@map("session")
  @@index([userId])
}

model Account {
  id                    String    @id @default(cuid())
  accountId             String
  providerId            String
  userId                String
  user                  User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  accessToken           String?
  refreshToken          String?
  idToken               String?
  accessTokenExpiresAt  DateTime?
  refreshTokenExpiresAt DateTime?
  scope                 String?
  password              String?
  createdAt             DateTime  @default(now())
  updatedAt             DateTime  @updatedAt

  @@map("account")
  @@index([userId])
}

model Verification {
  id         String   @id @default(cuid())
  identifier String
  value      String
  expiresAt  DateTime
  createdAt  DateTime @default(now())
  updatedAt  DateTime @default(now()) @updatedAt

  @@map("verification")
  @@index([identifier])
}

model Organization {
  id          String       @id @default(cuid())
  name        String
  slug        String
  logo        String?
  createdAt   DateTime
  metadata    String?
  members     Member[]
  invitations Invitation[]
  trackings   Tracking[]
  tags        Tag[]
  actions     Action[]

  @@unique([slug])
  @@map("organization")
}

model Member {
  id             String       @id @default(cuid())
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  userId         String
  user           User         @relation(fields: [userId], references: [id], onDelete: Cascade)
  role           String
  createdAt      DateTime

  @@unique([userId, organizationId])
  @@index([organizationId])
  @@index([userId])
  @@map("member")
}
model Invitation {
  id             String       @id @default(cuid())
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  email          String
  role           String?
  status         String
  expiresAt      DateTime
  inviterId      String
  user           User         @relation(fields: [inviterId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())

  @@map("invitation")
  @@index([organizationId])
  @@index([email])
}

model Tracking {
  id             String   @id @default(cuid())
  name           String
  description    String?
  organizationId String   @map("organization_id")
  isArchived     Boolean  @default(false) @map("is_archived")
  createdAt      DateTime @default(now()) @map("created_at")
  updatedAt      DateTime @updatedAt @map("updated_at")

  // Relacionamentos
  organization   Organization          @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  participants   TrackingParticipant[]
  status         Status[]
  leads          Lead[]
  tags           Tag[]
  winLossReasons WinLossReason[]
  actions        Action[]
  workflows      Workflow[]

  @@map("tracking")
}

enum ReasonType {
  WIN // Ganho
  LOSS // Perda
}

model WinLossReason {
  id         String     @id @default(cuid())
  name       String
  type       ReasonType // GANHO ou PERDA
  trackingId String     @map("tracking_id")
  isActive   Boolean    @default(true) @map("is_active")
  order      Int        @default(0)
  createdAt  DateTime   @default(now()) @map("created_at")

  tracking      Tracking      @relation(fields: [trackingId], references: [id], onDelete: Cascade)
  leadHistories LeadHistory[]

  @@index([trackingId])
  @@map("win_loss_reasons")
}

model TrackingParticipant {
  id         String          @id @default(cuid())
  userId     String          @map("user_id")
  trackingId String          @map("tracking_id")
  role       ParticipantRole @default(MEMBER)
  createdAt  DateTime        @default(now()) @map("created_at")
  tracking   Tracking        @relation(fields: [trackingId], references: [id], onDelete: Cascade)
  user       User            @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, trackingId])
  @@map("tracking_participant")
}

enum ParticipantRole {
  OWNER // Criador, controle total
  ADMIN // Pode gerenciar participantes
  MEMBER // Pode visualizar e interagir
  VIEWER // Apenas visualizaÃ§Ã£o
}

model Status {
  id         String   @id @default(cuid())
  name       String
  color      String?  @default("#1447e6")
  order      Int      @default(0)
  trackingId String   @map("tracking_id")
  createdAt  DateTime @default(now()) @map("created_at")
  updatedAt  DateTime @updatedAt @map("updated_at")

  // Relacionamentos
  tracking Tracking @relation(fields: [trackingId], references: [id], onDelete: Cascade)
  leads    Lead[]

  @@index([trackingId, order])
  @@map("status")
}

enum LeadAction {
  ACTIVE // Lead ativo no funil
  DELETED // ExcluÃ­do (lixeira)
  WON // Ganho
  LOST // Perdido
}

model LeadHistory {
  id        String     @id @default(cuid())
  leadId    String     @map("lead_id")
  action    LeadAction
  reasonId  String?    @map("reason_id")
  notes     String?
  userId    String     @map("user_id")
  createdAt DateTime   @default(now()) @map("created_at")

  // Relacionamentos
  lead   Lead           @relation(fields: [leadId], references: [id], onDelete: Cascade)
  reason WinLossReason? @relation(fields: [reasonId], references: [id], onDelete: SetNull)
  user   User           @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([leadId])
  @@index([action])
  @@index([createdAt])
  @@map("lead_history")
}

model Lead {
  id          String  @id @default(cuid())
  name        String
  email       String?
  phone       String?
  profile     String?
  description String?
  statusId    String  @map("status_id")
  trackingId  String  @map("tracking_id")
  responsibleId String? @map("responsible_id")
  order       Int     @default(0)

  currentAction LeadAction @default(ACTIVE) @map("current_action")
  isActive      Boolean    @default(true) @map("is_active")

  createdAt DateTime  @default(now()) @map("created_at")
  updatedAt DateTime  @updatedAt @map("updated_at")
  closedAt  DateTime? @map("closed_at")

  // Relacionamentos
  status   Status   @relation(fields: [statusId], references: [id], onDelete: Cascade)
  tracking Tracking @relation(fields: [trackingId], references: [id], onDelete: Cascade)
  responsible User? @relation("LeadResponsible", fields: [responsibleId], references: [id], onDelete: SetNull)

  leadTags LeadTag[]
  history  LeadHistory[]
  actions  Action[]

  @@index([phone])
  @@index([trackingId])
  @@index([statusId])
  @@index([email])
  @@index([createdAt])
  @@index([currentAction])
  @@index([isActive])
  @@index([responsibleId])
  @@unique([phone, trackingId])
  @@map("leads")
}

model Tag {
  id             String   @id @default(cuid())
  name           String
  color          String?  @default("#1447e6")
  organizationId String   @map("organization_id")
  trackingId     String?  @map("tracking_id") // ðŸ‘ˆ Opcional
  createdAt      DateTime @default(now()) @map("created_at")
  updatedAt      DateTime @updatedAt @map("updated_at")

  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  tracking     Tracking?    @relation(fields: [trackingId], references: [id], onDelete: Cascade)
  leadTags     LeadTag[]

  // ðŸ‘ˆ Importante: nome Ãºnico por contexto
  @@unique([name, organizationId, trackingId])
  @@index([organizationId])
  @@index([trackingId])
  @@map("tags")
}

model LeadTag {
  id        String   @id @default(cuid())
  leadId    String   @map("lead_id")
  tagId     String   @map("tag_id")
  createdAt DateTime @default(now()) @map("created_at")

  // Relacionamentos
  lead Lead @relation(fields: [leadId], references: [id], onDelete: Cascade)
  tag  Tag  @relation(fields: [tagId], references: [id], onDelete: Cascade)

  // Garantir que a mesma tag nÃ£o seja adicionada duas vezes ao mesmo lead
  @@unique([leadId, tagId])
  @@index([leadId])
  @@index([tagId])
  @@map("lead_tags")
}

model ActionsUserParticipant {
  id        String   @id @default(cuid())
  actionId  String   @map("action_id")
  userId    String   @map("user_id")
  createdAt DateTime @default(now()) @map("created_at")

  action Action @relation(fields: [actionId], references: [id], onDelete: Cascade)
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([actionId, userId])
  @@index([userId])
}

model ActionsUserResponsible {
  id       String @id @default(cuid())
  actionId String @map("action_id")
  userId   String @map("user_id")

  action Action @relation(fields: [actionId], references: [id], onDelete: Cascade)
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([actionId, userId])
  @@map("actions_user_responsibles")
}

enum TypeAction {
  TASK
  ACTION
  MEETING
  NOTE
}

model Action {
  id             String     @id @default(cuid())
  title          String
  description    String?
  score          Int        @default(0)
  isDone         Boolean    @default(false) @map("is_done")
  type           TypeAction @default(TASK)
  trackingId     String?    @map("tracking_id")
  organizationId String?    @map("organization_id")
  createdBy      String     @map("created_by")
  leadId         String?    @map("lead_id")
  startDate      DateTime?  @map("start_date")
  endDate        DateTime?  @map("end_date")
  closedAt       DateTime?  @map("closed_at")
  createdAt      DateTime   @default(now()) @map("created_at")

  user         User          @relation(fields: [createdBy], references: [id], onDelete: Cascade)
  lead         Lead?         @relation(fields: [leadId], references: [id], onDelete: SetNull)
  tracking     Tracking?     @relation(fields: [trackingId], references: [id], onDelete: SetNull)
  organization Organization? @relation(fields: [organizationId], references: [id], onDelete: SetNull)

  participants ActionsUserParticipant[]
  responsibles ActionsUserResponsible[]
  subActions   SubActions[]

  @@index([leadId])
  @@index([createdBy])
  @@index([isDone])
  @@index([type])
  @@index([startDate])
  @@index([endDate])
  @@index([closedAt])
  @@map("actions")
}

model SubActionUserResponsible {
  id          String @id @default(cuid())
  userId      String @map("user_id")
  subActionId String @map("sub_action_id")

  user      User       @relation(fields: [userId], references: [id], onDelete: Cascade)
  subAction SubActions @relation(fields: [subActionId], references: [id], onDelete: Cascade)

  @@unique([userId, subActionId])
  @@map("sub_actions_user_responsible")
}

model SubActions {
  id           String                     @id @default(cuid())
  title        String
  description  String?
  isDone       Boolean                    @default(false) @map("is_done")
  finishDate   DateTime?                  @map("finish_date")
  createdAt    DateTime                   @default(now()) @map("created_at")
  actionId     String                     @map("action_id")
  action       Action                     @relation(fields: [actionId], references: [id])
  responsibles SubActionUserResponsible[]

  @@index([actionId])
  @@index([isDone])
  @@index([finishDate])
  @@map("sub_action")
}

model Workflow {
  id         String   @id @default(cuid())
  name       String
  description String?
  userId     String?  @map("user_id")
  trackingId String   @map("tracking_id")
  createdAt  DateTime @default(now()) @map("created_at")
  updatedAt  DateTime @updatedAt  @map("updated_at")

  user     User?    @relation(fields: [userId], references: [id], onDelete: SetNull)
  tracking Tracking @relation(fields: [trackingId], references: [id], onDelete: Cascade)

  nodes Node[]
  connections Connection[]

  @@map("workflows")
}

enum NodeType {
  INITIAL
  MANUAL_TRIGGER
  HTTP_REQUEST
}

model Node {
  id String @id @default(cuid())
  workflowId String @map("workflow_id")
  name String
  type NodeType
  position Json
  data Json @default("{}")

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt  @map("updated_at")

  workflow Workflow @relation(fields: [workflowId], references: [id], onDelete: Cascade)

  outputConnections Connection[] @relation("FromNode")
  inputConnections Connection[] @relation("ToNode")

  @@map("nodes")
}

model Connection {
  id String @id @default(cuid())
  workflowId String @map("workflow_id")
  fromNodeId String @map("from_node_id")
  toNodeId String @map("to_node_id")
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt  @map("updated_at")
  fromOutput String @default("main")
  toInput String @default("main")

  workflow Workflow @relation(fields: [workflowId], references: [id], onDelete: Cascade)
  fromNode Node @relation("FromNode", fields: [fromNodeId], references: [id], onDelete: Cascade)
  toNode Node @relation("ToNode", fields: [toNodeId], references: [id], onDelete: Cascade)

  @@unique([fromNodeId, toNodeId, fromOutput, toInput])
  @@map("connections")
}